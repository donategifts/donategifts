<!DOCTYPE html>
<html lang="en">
  <head>
    <title>See Wish Cards | Donate Gifts</title>
    <!-- ** NOTE: CDN Bootstrap.js, Popper.js, and jQuery are moved to the bottom so the page loads faster-->
    <%- include('./templates/header')-%>
    <link rel="stylesheet" href="/public/css/search.css" />
    <script src="/public/clientJS/utils.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- facebook login -->
    <script>
      window.fbAsyncInit = function () {
        FB.init({
          appId: '<%- process.env.FB_APP_ID %>',
          cookie: true,
          xfbml: true,
          version: 'v8.0',
        });
        FB.AppEvents.logPageView();
      };
      (function (d, s, id) {
        var js,
          fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = 'https://connect.facebook.net/en_US/sdk.js';
        fjs.parentNode.insertBefore(js, fjs);
      })(document, 'script', 'facebook-jssdk');
    </script>

    <!-- google login -->
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="<%- process.env.G_CLIENT_ID %>" />
    <script src="/public/clientJS/login.js"></script>
  </head>

  <body>
    <%- include('./templates/loginModal')-%> <%- include('./templates/nav')-%> <%-
    include('./templates/wishCardDonateModal')-%>

    <!-- Wish Card deck -->
    <div class="wishcards">
      <!-- Search Bar -->
      <div class="row justify-content-center quick-font" id="margin-bottom">
        <div class="col-12 col-md-10 col-lg-8">
          <!-- Search form -->
          <form id="searchBar" action="/wishcards/search" method="POST">
            <div class="card card-sm">
              <div class="card-body row no-gutters align-items-center">
                <div class="col-auto">
                  <i class="fa fa-search h4 text-body" aria-hidden="true"></i>
                </div>
                <div class="col">
                  <input
                    class="form-control form-control-lg form-control-borderless"
                    type="search"
                    name="wishitem"
                    placeholder="Search Wish Cards"
                  />
                </div>
                <div class="col-auto">
                  <button class="wishcard__button--blue bdr-2" type="submit">Search</button>
                </div>
              </div>
            </div>
            <div class="col mt-3">
              <div class="row">
                <div id="filter-panel" class="collapse filter-card ml-auto">
                  <div class="card">
                    <div class="card-body form-inline">
                      <div class="form-group">
                        <label class="filter-col" style="margin-right: 0" for="card-limit">Card limit</label>
                        <select id="card-limit" class="form-control" name="limit">
                          <option value="10">10</option>
                          <option value="20">20</option>
                          <option value="25" selected="selected">25</option>
                          <option value="50">50</option>
                          <option value="100">100</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="filter-col" style="margin-right: 0" for="child-age">Age range</label>
                        <select id="child-age" class="form-control" name="childAge">
                          <option value="14" selected="selected">Kids younger than 15</option>
                          <option value="15">Kids older than 15</option>
                        </select>
                      </div>
                      <div class="form-group ml-4">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" style="margin-right: 10px" name="donated" />
                            Show already donated ones
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col text-right mt-2">
                <button
                  type="button"
                  class="wishcard__link--white bdr-2"
                  style="width: auto"
                  data-toggle="collapse"
                  data-target="#filter-panel"
                >
                  Advanced Search
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Dynamic Card Display now fixed and responsive-->

      <div class="container">
        <% if (wishcards.length === 0) { %>
        <h1>No wishcards</h1>
        <% } else { %>
        <div class="row justify-content-center">
          <% for (var i = 0; i < wishcards.length; i++) { %>
          <div class="col-lg-4 col-xs-12 mb-5">
            <!-- Card -->
            <div id="card-fix" class="card h-100">
              <!--Card image-->
              <div class="view overlay">
                <img id="img-fix" class="card-img-top" src="<%= wishcards[i].wishCardImage %>" alt="Card image" />
                <a href="#">
                  <div class="mask rgba-white-slight"></div>
                </a>
              </div>
              <!--Card content-->
              <div class="card-body">
                <a href="/wishcards/<%= wishcards[i]._id %>" class="wishcard__icon--fixed msg-icon">
                  <i class="far fa-envelope" aria-hidden="true"></i>
                </a>
                <div class="card-text-container">
                  <!--Title-->
                  <h3 class="card-title text-center crayon-font">My name is <%= wishcards[i].childFirstName %></h3>
                  <!--Text-->
                  <div class="quick-font">
                    <p class="card-text">
                      <span class="font-weight-bold">Wish : </span>
                      <%= wishcards[i].wishItemName.length > 25 ? wishcards[i].wishItemName.substring(0, 25) + "..." :
                      wishcards[i].wishItemName %>
                    </p>
                    <p class="card-text">
                      <span class="font-weight-bold">Item Price :</span> $<%= wishcards[i].wishItemPrice %>
                    </p>
                    <p class="card-text">
                      <span class="font-weight-bold">Interest : </span>
                      <%= wishcards[i].childInterest.length > 30 ? wishcards[i].childInterest.substring(0, 30) + "..." :
                      wishcards[i].childInterest %>
                    </p>
                  </div>
                  <div class="quick-font mt-4 row justify-content-center align-items-center">
                    <div class="col-sm-6 my-2 text-center">
                      <a href="/wishcards/<%= wishcards[i]._id %>" class="wishcard__link--white bdr-2"> Read more </a>
                    </div>
                    <div class="col-sm-6 my-2 text-center">
                      <button
                        type="button"
                        data-toggle="modal"
                        id="donate-btn-<%= wishcards[i]._id %>"
                        data-value-url="<%= wishcards[i].wishItemURL %>"
                        data-value-name="<%= wishcards[i].childFirstName %>"
                        data-value-id="<%= wishcards[i]._id %>"
                        data-value-loggedIn="<%= !!locals.user %>"
                        <% if (locals.user) { %>
                        data-value-user="<%= locals.user._id %>"
                        data-target="#wishCardDonateModal"
                        <% } else { %>
                        data-target="#loginModalCenter"
                        <% } %>
                        class="wishcard__button--blue bdr-2"
                      >
                        Donate Gift
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        </div>
        <% } %>
      </div>
    </div>

    <%- include('./templates/footer')-%>
    <script>
      countdown = [];
      <% for (let i = 0; i < wishcards.length; i++) { %>
        <% if (new Date(wishcards[i].isLockedUntil) > new Date()) { %>
          console.log("LOCKED WISHCARD")
          addCountdown('<%= wishcards[i].isLockedUntil %>', '<%= wishcards[i]._id %>', '#donate-btn-<%= wishcards[i]._id %>')
        <% } %>
      <% } %>
    </script>
    <script src="/public/clientJS/wishCard.js"></script>
    <script src="/public/clientJS/wishCardModal.js"></script>
    <!--  this is for login toast -->
    <% if(!locals.user) { %>
    <script src="/public/clientJS/loginToast.js"></script>
    <% } %>
  </body>
</html>
