extends ../../master

block title
    title See Wish Cards | Donate Gifts

block content
    #profile-bg.background-color
        .profile-title
            .text-center.fs-1 Wishcard admin panel
    .wishcards.background-color
        .container
            if agenciesWithWishCards.size === 0
                h1 No wishcards
            else
                each val, key in agenciesWithWishCards
                    h2#cray-font Agency name: #{key}
                    .row.justify-content-center.agency-card-container
                        each card in val
                            .col-lg-4.col-xs-12.mb-5.mt-4
                                .card.mb-3
                                    .view.overlay
                                        img#img-fix.card-img-top( src=card.wishCardImage alt='Card image' )
                                        a( href='#' )
                                            .mask.rgba-white-slight
                                    .card-body.card-details
                                        .card-text-container
                                            h3.card-title.text-center My name is
                                                |
                                                |
                                                = card.childFirstName

                                            .quick-font
                                                p.card-text
                                                    span.font-weight-bold Status:
                                                        |
                                                        |
                                                        = card.status
                                                p.card-text
                                                    span.font-weight-bold Age:
                                                        |
                                                        |
                                                        = card.age
                                                p.card-text
                                                    - var wishItemName = card.wishItemName.length > 25 ? card.wishItemName.substring(0, 25) + '...' : card.wishItemName

                                                    span.font-weight-bold Wish:
                                                        |
                                                        |
                                                        = wishItemName
                                                    p.card-text
                                                        - var wishItemPrice = '$ ' + card.wishItemPrice

                                                        span.font-weight-bold Item Price:
                                                            |
                                                            |
                                                            = wishItemPrice
                                                    p
                                                        span Item Url:
                                                            |
                                                            |
                                                            a( id='oldWishItemUrl' + card._id href=card.wishItemURL ) Link

                                                    input.input1( id='newWishItemUrl' + card._id type='text' name='newWishItemUrl' placeholder='Url for wish item...' )
                                                    button.card-details-publish-button( type='button' id='donate-btn-' + card._id data-value-id=card._id ) Publish WishCard

append scripts
    script.
        $(document).ready(() => {
            aler("HELL")
            const unlockCardButtonClick = (e) => {
                const elementRef = e.target;
                const wishCardId = elementRef.dataset.valueId;
                const $oldItemUrl = $('#oldWishItemUrl' + wishCardId);
                const $newItemUrl = $('#newWishItemUrl' + wishCardId);
                const wishItemUrl = $newItemUrl.val() !== '' ? $newItemUrl.val() : $oldItemUrl.attr('href');

                console.log(wishItemUrl);

                $.ajax({
                    type: 'PUT',
                    url: '/admin',
                    data: {
                        wishCardId,
                        wishItemUrl,
                    },
                    success: (_) => {
                        showToast('Card status updated');
                        removeWishCardFromDOM(elementRef);
                    },
                    error: (response) => {
                        showToast(response.error.msg);
                    },
                });
            }

            const removeWishCardFromDOM = (node) => {
                const divName = 'row justify-content-center';
                if (node.parentNode.className !== divName) {
                    removeWishCardFromDOM(node.parentNode);
                } else {
                    while (node.firstChild) {
                        node.removeChild(node.lastChild);
                    }
                }
            }

            $('.col.wishcard-btn.btn-navy-bg').each(function () {
                $(this).click(unlockCardButtonClick);
            })
        });
