FROM node:15-alpine

# package json
COPY ./package.json /app/package.json

# build files
COPY ./dist /app/dist

WORKDIR /app

ARG NPM_TOKEN

# install modules
RUN apk add --no-cache --virtual .build-deps alpine-sdk python && \
 echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
    npm install --production && \
    rm -f .npmrc && \
    apk del .build-deps

ARG NODE_ENV
# ARG RELEASE
ARG MONGO_URI
ARG NODE_ENV
ARG TS_NODE_FILES
ARG SESS_NAME
ARG SESS_SECRET
ARG SESS_LIFE
ARG MAILGUN_API_KEY
ARG MAILGUN_DOMAIN
ARG USE_AWS
ARG S3BUCKET
ARG DEFAULT_EMAIL
ARG BASE_URL
ARG FB_APP_ID
ARG G_API_KEY
ARG G_CLIENT_ID
ARG G_CLIENT_SECRET
ARG LOCAL_DEVELOPMENT
ARG SOCKET_URL
ARG AWS_KEY
ARG AWS_SECRET
ARG STRIPE_API
ARG STRIPE_KEY

ENV NODE_ENV=$NODE_ENV
# ENV RELEASE=$RELEASE
ENV DB_POOL_SIZE=50
ENV MONGO_URI=$MONGO_URI
ENV TS_NODE_FILES=$TS_NODE_FILES
ENV SESS_NAME=$SESS_NAME
ENV SESS_SECRET=$SESS_SECRET
ENV SESS_LIFE=$SESS_LIFE
ENV MAILGUN_API_KEY=$MAILGUN_API_KEY
ENV MAILGUN_DOMAIN=$MAILGUN_DOMAIN
ENV USE_AWS=$USE_AWS
ENV S3BUCKET=$S3BUCKET
ENV DEFAULT_EMAIL=$DEFAULT_EMAIL
ENV BASE_URL=$BASE_URL
ENV FB_APP_ID=$FB_APP_ID
ENV G_API_KEY=$G_API_KEY
ENV G_CLIENT_ID=$G_CLIENT_ID
ENV G_CLIENT_SECRET=$G_CLIENT_SECRET
ENV LOCAL_DEVELOPMENT=$LOCAL_DEVELOPMENT
ENV SOCKET_URL=$SOCKET_URL
ENV AWS_KEY=$AWS_KEY
ENV AWS_SECRET=$AWS_SECRET
ENV STRIPE_API=$STRIPE_API
ENV STRIPE_KEY=$STRIPE_KEY

EXPOSE 3005

CMD npm run start
